name: Deploy to VPS

on:
  push:
    branches:
      - main # 假设您的主分支是 main，如果是 master 请替换为 master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          SSH_KEY_FILE=$(mktemp)
          echo "$VPS_SSH_KEY" > $SSH_KEY_FILE
          chmod 600 $SSH_KEY_FILE

          ssh -o StrictHostKeyChecking=no -i $SSH_KEY_FILE -p $VPS_PORT $VPS_USER@$VPS_HOST "
            cd /home/deployer/taxonomy &&
            # 查找并杀死正在运行的进程
            if pgrep -f 'pnpm preview'; then
              pkill -f 'pnpm preview'
            fi &&
            # 更新代码
            git pull &&
            # 安装依赖
            pnpm install &&
            # 重新启动进程
            nohup pnpm preview > /home/deployer/taxonomy/preview.log 2>&1 &
          "

          rm -f $SSH_KEY_FILE
